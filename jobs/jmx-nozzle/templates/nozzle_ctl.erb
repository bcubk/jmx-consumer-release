#!/bin/bash -e

RUN_DIR=/var/vcap/sys/run/jmx-nozzle
LOG_DIR=/var/vcap/sys/log/jmx-nozzle
PACKAGE_DIR=/var/vcap/packages/jmx-nozzle
PIDFILE=$RUN_DIR/jmx-nozzle.pid
CONFIG_DIR=/var/vcap/jobs/jmx-nozzle/config
JAVA_HOME=/var/vcap/packages/jmx-nozzle/jdk
TMPDIR=/var/vcap/packages/jmx-nozzle/tmp

case $1 in

start)
mkdir -p $RUN_DIR
mkdir -p $TMPDIR

chown -R vcap:vcap $RUN_DIR
chown -R vcap:vcap $TMPDIR

mkdir -p $LOG_DIR
chown -R vcap:vcap $LOG_DIR

echo $$ > $PIDFILE

hostname=<%=  spec.address %>

exec chpst -u vcap:vcap $JAVA_HOME/bin/java \
-Dlog-level= \
-Dcom.sun.management.jmxremote.authenticate=false \
-Dcom.sun.management.jmxremote.registry.ssl=false \
-Dcom.sun.management.jmxremote.ssl=false \
-Dcom.sun.management.jmxremote.ssl.need.client.auth=false \
-Djava.rmi.server.hostname=$hostname \
-jar $PACKAGE_DIR/jmx-nozzle-1.0-SNAPSHOT.jar \
>>$LOG_DIR/jmx-nozzle.stdout.log \
2>>$LOG_DIR/jmx-nozzle.stderr.log

;;

stop)
kill -9 $(cat $PIDFILE)

;;

*)
echo "Usage: jmx-nozzle {start|stop}"

;;

esac
