set -e -x

cd ${BUILD_DIR}

# Make sure we can see uname
export PATH=$PATH:/bin:/usr/bin

#unpack Java - we support Mac OS 64bit and Linux 64bit otherwise we require JAVA_HOME to point to JDK
if [ `uname` = "Linux" ]; then
  mkdir java
  cd java
  tar zxvf ../openjdk/openjdk-*.tar.gz
  export JAVA_HOME=${BUILD_DIR}/java/jdk-9.0.4
else
  if [ ! -d $JAVA_HOME ]; then
    echo "JAVA_HOME properly set is required for non Linux/Darwin builds."
    exit 1
  fi
fi

#setup Java path
export PATH=$JAVA_HOME/bin:$PATH

#build cloud foundry jmx-consumer jar
cd ${BUILD_DIR}/jmxconsumer

# Run build
./gradlew :clean :assemble
cp build/libs/*.jar ${BUILD_DIR}/jmxconsumer

#clean build jmx-consumer data and build tools (java)
./gradlew clean
cd ${BUILD_DIR}
rm -rf java